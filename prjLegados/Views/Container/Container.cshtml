@model prjLegados.Models.ClsContainer

@{
    ViewBag.Title = "Administración Archivos A";
    Layout = "~/Views/Shared/_Layout.cshtml";

}


<h2 class=" text-center">Administración de Archivos</h2>
<h1 class=" text-center">Bienvenidos</h1>
<div class="MainContainer">
    <div id="Botones" class=" text-center">
        <a href="#" class="btn btn-group" id="NewContainer" onclick="AddNewContainer()">Nueva Agrupación</a>
        <a href="#" class="btn btn-group" id="DeleteContainer">Borrar Contenedor</a>
        <a href="#" class="btn btn-group" id="Upload">Subir Archivos</a>
    </div> <br />
    <div id="Filtros">
        <table>
            <tr>
                <td>
                    <table id="Tabla">
                        <tr id="Columna">
                            <td id="Fila">
                                <label>Ingrese Búsqueda</label>
                            </td>
                            <td id="Fila" colspan="3">
                                <input type="text" class="form-control-static" id="buscar" style="width:100%;min-width: 100%;max-width: 100%;">
                            </td>
                            <td>
                                <a href="#" class="btn btn-info" id="BuscarBlobs">Buscar</a>
                            </td>
                        </tr>
                        <tr id="Columna">
                            <td id="Fila"><label>Agrupación</label></td>
                            <td id="Fila">
                                <select class="form-control" id="cbxContainer">
                                    <option>
                                        Seleccione Opción
                                    </option>
                                    @foreach (var item in Model.lstContainers)
                                     {
                                            <option>
                                                @Html.DisplayFor(modelItem => item.fntFullNameStr)
                                            </option>
                                     }
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td id="Fila">
                                <label>Aplicación</label>
                            </td>
                            <td id="Fila">
                                <select class="form-control" id="cbxAplication">
                                    <option>Seleccione Opción</option>
                                    @foreach (var item in Model.usrUser.fntAplicationsLst)
                                     {
                                        <option>
                                            @Html.DisplayFor(modelItem => item)
                                        </option>
                                     }
                                </select>
                            </td>
                        </tr>
                        <tr id="Columna">
                            <td id="Fila">
                                <label>Módulo</label>
                            </td>
                            <td id="Fila">
                                <select class="form-control" id="cbxFilterText">
                                    <option value="">Seleccione Opción</option>
                                    <option value="contains">Contiene</option>
                                    <option value="eq">Igual que</option>
                                    <option value="ne">No es igual que</option>
                                    <option value="starts with">Empieza con</option>
                                    <option value="ends with">Termina con</option>
                                </select>
                            </td>
                            <td id="Fila">
                                <input type="text" name="txtFilterModule" id="txtFilterModule" />
                            </td>
                        </tr>
                        <tr id="Col8">
                            <td><label>Descripción</label></td>
                            <td>
                                <select class="form-control" id="cbxDescriptionName">
                                    <option value="">Seleccione Opción</option>
                                    <option value="contains">Contiene</option>
                                    <option value="eq">Igual que</option>
                                    <option value="ne">No es igual que</option>
                                    <option value="startswith">Empieza con</option>
                                    <option value="endswith">Termina con</option>
                                </select>
                            </td>
                            <td><input type="text" name="txtDescription" id="txtDescription" /></td>
                        </tr>
                    </table>
                </td>
                <td valign="bottom">
                    <input type="button" name="btnPanelAdvanced" value="Avanzado" id="btnPanelAdvanced" />
                </td>
                <td>
                    <div id="panelAdvanced" style="display:none">
                        <table>
                            <tr id="Columna">
                                <td id="Fila">
                                    <label>Año de Referencia</label>
                                </td>
                                <td id="Fila">
                                    <select class="form-control" id="cbxFilterAnio">
                                        <option value="">Seleccione Opción</option>
                                        <option value="eq">Igual</option>
                                        <option value="between">Entre</option>
                                        <option value="ge">Mayor a</option>
                                        <option value="le">Menor a</option>
                                    </select>
                                </td>
                                <td id="Fila">
                                    <input type="text" name="txtAnio" id="txtAnio" class="form-control-static" />
                                </td>
                                <td id="rowPopUpTextBox" style="display:none">
                                    <input type="text" name="txtAnioBetween" id="txtAnioBetween" class="form-control-static" />
                                </td>
                            </tr>
                            <tr id="Columna2">
                                <td id="Fila">
                                    <label>Mes de Referencia</label>
                                </td>
                                <td id="Fila">
                                    <select class="form-control" id="cbxFilterTextMonth">
                                        <option value="">Seleccione Opción</option>
                                        <option value="eq">Igual</option>
                                        <option value="between">Entre</option>
                                        <option value="ge">Mayor a</option>
                                        <option value="le">Menor a</option>
                                    </select>
                                </td>
                                <td id="Fila">
                                    <select class="form-control" id="cbxFilterMes">
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </td>
                                <td id="newTextBox" style="display:none">
                                    <select class="form-control" id="cbxFilterMesBetween">
                                        <option value="1">Enero</option>
                                        <option value="2">Febrero</option>
                                        <option value="3">Marzo</option>
                                        <option value="4">Abril</option>
                                        <option value="5">Mayo</option>
                                        <option value="6">Junio</option>
                                        <option value="7">Julio</option>
                                        <option value="8">Agosto</option>
                                        <option value="9">Septiembre</option>
                                        <option value="10">Octubre</option>
                                        <option value="11">Noviembre</option>
                                        <option value="12">Diciembre</option>
                                    </select>
                                </td>
                            </tr>
                            <tr id="Col3">
                                <td><label>Nombre Archivo</label></td>
                                <td>
                                    <select class="form-control" id="cbxFileName">
                                        <option value="">Seleccione Opción</option>
                                        <option value="contains">Contiene</option>
                                        <option value="eq">Igual que</option>
                                        <option value="ne">No es igual que</option>
                                        <option value="starts with">Empieza con</option>
                                        <option value="ends with">Termina con</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="txtFileName" id="txtFileName" />
                                </td>
                            </tr>
                            <tr id="Col4">
                                <td><label>Nombre Alterno Archivo</label></td>
                                <td>
                                    <select class="form-control" id="cbxAlterName">
                                        <option value="">Seleccione Opción</option>
                                        <option value="contains">Contiene</option>
                                        <option value="eq">Igual que</option>
                                        <option value="ne">No es igual que</option>
                                        <option value="starts with">Empieza con</option>
                                        <option value="ends with">Termina con</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="txtAlterName" id="txtAlterName" />
                                </td>
                            </tr>
                            @*<tr id="Col4">
                                <td><label>Tipo Archivo</label></td>
                                <td>
                                    <input type="text" name="txtExtensionFile" id="txtExtensionFile" disabled />
                                </td>
                            </tr>
                            <tr id="Col5">
                                <td><label>Empresa</label></td>
                                <td>
                                    <input type="text" name="txtCompanyFile" id="txtCompanyFile" disabled />
                                </td>
                            </tr>*@
                            <tr id="Col6" hidden="hidden">
                                <td><label>Fecha Carga</label></td>
                                <td>
                                    <select class="form-control" id="cbxDateUploadFile">
                                        <option value="">Seleccione Opción</option>
                                        <option value="eq">Igual</option>
                                        <option value="between">Entre</option>
                                        <option value="ge">Mayor a</option>
                                        <option value="le">Menor a</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="date" name="txtDateUploadFile" id="txtDateUploadFile" />
                                </td>
                                <td id="rowOtherDateUpload" style="display:none">
                                    <input type="date" name="txtSecondDateUploadFile" id="txtSecondDateUploadFile" />
                                </td>
                            </tr>
                            <tr id="Col7">
                                <td>
                                    <label>Tags</label>
                                </td>
                                <td>
                                    <select class="form-control" id="cbxTags">
                                        <option value="">Seleccione Opción</option>
                                        <option value="eq">Igual a</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" data-role="tagsinput" title="No existen espacios y se debe separar por comas(,)" name="txtTags" id="txtTags" />
                                </td>
                            </tr>

                        </table>
                        <input type="button" id="btnClose" name="btnClose" value="Cerrar" />
                    </div>
                </td>
            </tr>
        </table>

    </div>

    <div class="Control" id="campos">
    </div>
    <div id="">

    </div>
    <div  class="progress" id="progress"  style="display:none">
        <div class="progress-bar progress-bar-striped active" role="progressbar" aria-valuenow="40" aria-valuemin="0" aria-valuemax="100" style="width:100%">
            <label>Espere por favor mientras su búsqueda esta siendo procesada</label>
        </div>
    </div>
 
    <div class="list-group" id="listResult" style="display:none">
        
    </div>
</div>

@*Modal Nuevo Contenedor*@

<div class="modal fade" id="MyModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
            </div>
            <div class="modal-body">
                <form id="form">
                    <fieldset id="SubmitForm">
                        <div class="form-group">
                            <h4 id="ModalTitle" class="text-center">Nueva Agrupación</h4>
                            <label>Nombre de la Agrupación</label>
                            @Html.TextBox("txtNombreContainer")
                        </div>

                        <div class="form-group">
                            <a href="#" class="btn btn-primary" id="SaveContainer">Guardar</a>
                            <a href="#" class="btn btn-primary" id="ExitContainer">Salir</a>
                        </div>

                    </fieldset>
                </form>
            </div>
        </div>
    </div>
</div>

@*Modal Nuevo Subir Archivo*@
<div class="modal fade" id="MyModalUpload">
    <div class="modal-dialog" id="MyModalUploadDialog">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4 id="ModalTitleUpload"></h4>
            </div>
            <div class="modal-body" id="modal-body">
            </div>
        </div>
    </div>
</div>
@*Modal Eliminar Agrupacion*@
<div class="modal fade" id="MyModalDelete">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4 id="ModalTitle"></h4>
            </div>
            <div class="modal-body" id="modal-content">
            </div>
        </div>
    </div>
</div>

@*Modal New Upload*@
<div class="modal fade" id="MyModalNewUpload">
    <div class="modal-dialog" id="ModalDialog">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4 id="ModalTitle"></h4>
            </div>
            <div class="modal-body" id="modalContent">
            </div>
        </div>
    </div>
</div>


@*Modal View File*@
<div class="modal fade" id="MyModalFile">
    <div class="modal-dialog" id="ModalDialogFile">
        <div class="modal-content">
            <div class="modal-header">
                <a href="#" class="close" data-dismiss="modal">&times;</a>
                <h4 id="ModalTitle"></h4>
            </div>
            <div class="modal-body" id="modalContentFile">
            </div>
        </div>
    </div>
</div>

@section Scripts{
@*<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">*@
<script>
        var filterFileName;
        var filterAlterName;
        var filterContainer;
        var filterApplication;
        var filterExtension;
        var filterCompany;
        var filterModule;
        var filterDocumentUploadAt;
        var filterReferencialYear;
        var filterReferencialMonth;
        var filterTags;
        var filerDescription;
        var lstFilterMetadata = [];


        function AddNewContainer() {
            $("#MyModal").modal();
           
    };

    function llenarApplication() {
        var cbxApplication = $("#cbxAplication");
        for (var i = 0; i < example.length; i++){
            cbxApplication.append('<option>' + example[i] + '</option>');
        }
        
    };
        function validarNuevoContenedor() {
            if ($("#txtNombreContainer").val() == "") {
                return false;
            } else {
                return true;
            }
    };

        $("#SaveContainer").click(function () {
            if (validarNuevoContenedor() != true) {
                alert("Debe digitar el nombre del contenedor");
            } else {
                $.ajax({
                    type: "POST",
                    url: "/Container/sveContainer",
                    data: '{name: "' + $("#txtNombreContainer").val().toLowerCase() + '" }',
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (response) {
                        alert(response.mensaje);
                        window.location.href = "/Container/Container";
                        $("#MyModal").modal("hide");

                    },
                    failure: function (response) {
                        alert(response.responseText);
                    },
                    error: function (response) {
                        alert(response.responseText);
                    }
                });
            }
        });


                    $("#ExitContainer").click(function () {
                        $.ajax({
                            success: function () {
                                $("#MyModal").modal("hide");
                            }
                        });
                    });

                    $("#DeleteContainer").click(function () {
                        var ajaxCallURL = "/Container/DeleteContainer";
                        var options = {
                            "backdrop": "static",
                            keyboard: true
                        };
                        $.ajax({
                            type: "GET",
                            url: ajaxCallURL,
                            contentType: "application/json; charset=utf-8",
                            datatype: "json",
                            success: function (data) {
                                $("#MyModalDelete").modal("show");
                                $("#modal-content").html(data);
                            }
                        });
                    });
                    $("#BuscarBlobs").click(function () {
                        @*if (!Comprobar()) {
                            alert("Debe seleccionar los campos respectivos");
                        } else {
                            $("#labelTitulo").remove();
                            $("#tablaBlobs").remove();
                            var mitexto = $("#sel1 option:selected").text();
                            campo = '<label id="labelTitulo">Contenedor ' + mitexto;
                            $("#campos").append(campo);
                            $(this).prop("disabled", "disabled");
                            var url = "@Url.Action("bscBlobs", "Container")";
                            var NombreContainer = $("#cbxContainer").val();
                            var data = { nombreContainer: NombreContainer };
                            $.get(url, data).done(function (data) {

                                $("#divTabla").append(data);
                            }).fail("fallo");
                        }*@
                        fntFilterStaticAttributes();
                        fntFilterAttributes();
                        fntFilterAdvanced();
                        $("#progress").show();
                        $("#listResult").empty();
                        var searchWord = $("#buscar").val();
                        var clsDocumentPdfSearch = {
                            "TopResults": 10,
                            "SkipResults": 0,
                            "SearchWords": searchWord,
                            "FilterMetadata": lstFilterMetadata
                        };
                        
                        $.ajax({
                            data: { parameters: clsDocumentPdfSearch},
                            type: "POST",
                            dataType: "json",
                            url: "/Container/fntAzureSearch",
                            success: function (data) {
                                if (data.length != 0) {
                                    $("#listResult").append("<label>Los Resultados de la búsqueda son:</label></br>");
                                    $("#listResult").show();
                                    for (var i = 0; i < data.length; i++) {
                                        var description = '<p class="list-group-item-text">' + data[i].container + " || " + data[i].application + " || " + data[i].module + '</p>';
                                        var descriptionDate = '<p class="list-group-item-text">' + new Date(data[i].documentUploadAt.match(/\d+/)[0] * 1).toLocaleString() + " || " + data[i].referencialYear + " || " + data[i].referencialMonth + '</p>';
                                        var tittle = '<h4 class="list-group-item-heading">' + data[i].alterName + "\tPágina: " + data[i].page + '</h4>';
                                        var hrefAlterName = '<a href="' + data[i].uri + '" id="dataLinkInformation" target="_blank" class="list-group-item">' + tittle + descriptionDate + description + '</a>';
                                        $("#listResult").append(hrefAlterName);
                                    }
                                    $("#progress").hide();
                                    lstFilterMetadata = [];
                                    //$("#buscar").val("");
                                } else {
                                    $("#progress").hide();
                                    $("#listResult").show();
                                    var messageNotFound = '<label>No se encontraron resultados en la búsqueda';
                                    $("#listResult").append(messageNotFound);
                                    lstFilterMetadata = [];
                                    //$("#buscar").val(""); 
                                }
                                
                            }
                        }).fail("falló");
                    });


                    function Comprobar() {
                        var container = $("#cbxContainer").val();
                        var aplication = $("#cbxAplication").val();
                        if (container == "Seleccione el Contenedor" || aplication == "Seleccione Aplicación") {
                            return false;
                        } else {
                            return true;
                        }
                    };
                    $("#Upload").click(function () {
                        $.ajax({
                            type: "GET",
                            url: "/Container/NewUpload",
                            success: function (data) {
                                $("#modalContent").html(data);
                                $("#MyModalNewUpload").modal("show");
                            }

                        });
                    });

                    $("#cbxFilterTextMonth").on("change", function () {
                        if ($("#cbxFilterTextMonth").val() == "Entre") {
                            $("#newTextBox").show();
                        }

                    });

                    $("#cbxFilterAnio").on("change", function () {
                        if ($("#cbxFilterAnio").val() == "Entre") {
                            $("#rowPopUpTextBox").show();
                        }

                    });

                    $("#cbxDateUploadFile").on("change", function () {
                        if ($("#cbxDateUploadFile").val() == "Entre") {
                            $("#rowOtherDateUpload").show();
                        }

                    });

                    $("#btnPanelAdvanced").click(function () {
                        $("#panelAdvanced").show();
                        $("#btnPanelAdvanced").hide();
                    });

                    $("#btnClose").click(function () {
                        $("#panelAdvanced").hide();
                        $("#btnPanelAdvanced").show();
                    });

                    function fntFilterStaticAttributes() {
                        var lstFieldName = [];
                        var lstFieldValue = [];

                        if ($("#cbxContainer").val() != "Seleccione Opción") {
                            lstFieldValue.push($("#cbxContainer").val());
                            lstFieldName.push("container");
                        }

                        if ($("#cbxAplication").val() != "Seleccione Opción") {
                            lstFieldValue.push($("#cbxAplication").val());
                            lstFieldName.push("application");
                        }
                        lstFieldValue.push("pdf");
                        lstFieldValue.push("maresa");
                        lstFieldName.push("extension");
                        lstFieldName.push("company");

                        for (var i = 0; i < lstFieldName.length; i++) {
                            var clsOperationFilterAzure = {
                                "FieldName": lstFieldName[i],
                                "ComparisonExpresion": "eq",
                                "FieldValue": lstFieldValue[i],
                                "FieldType": "string"
                            };
                            lstFilterMetadata.push(clsOperationFilterAzure);
                        }
                    };

                    function fntFilterAttributes() {
                        var option = "Seleccione Opción";
                        var expresionBetween = "between";
                        //var cbxModule = $("#cbxFilterText").val();
                        //var cbxMonth = $("#cbxFilterTextMonth").val();
                        //var cbxYear = $("#cbxFilterAnio").val();

                        var lstFieldName = ["module", "referencialMonth", "referencialYear"];
                        //var lstExpresion = [$("#cbxFilterText").prop("value"), $("#cbxFilterTextMonth").prop("value"), $("#cbxFilterAnio").prop("value")];
                        var lstExpresion = [$("#cbxFilterText").val(), $("#cbxFilterTextMonth").val(), $("#cbxFilterAnio").val()];
                        var lstFieldValue = [$("#txtFilterModule").val(), $("#cbxFilterMes").prop("value"), $("#txtAnio").val()];
                        var lstFieldType = ["string", "int", "int"];


                        for (var i = 0; i < lstFieldName.length; i++) {
                            if (lstExpresion[i] != "") {
                                if (lstExpresion[i] != expresionBetween) {
                                    var clsOperationFilterAzure = {
                                        "FieldName": lstFieldName[i],
                                        "ComparisonExpresion": lstExpresion[i],
                                        "FieldValue": lstFieldValue[i],
                                        "FieldType": lstFieldType[i]
                                    };
                                    lstFilterMetadata.push(clsOperationFilterAzure);
                                }
                                //TODO: AGREGAR LA EXPRESION BETWEEN
                            }
                        }

                    }

                    function fntFilterAdvanced() {
                        var option = "Seleccione Opción";
                        var expresionBetween = "between";
                        var cbxFileName = $("#cbxFileName").val();
                        var cbxAlterName = $("#cbxAlterName").val();
                        var cbxDocumentUploadAt = $("#cbxDateUploadFile").val();
                        var cbxTags = $("#cbxTags").val();
                        var cbxDescription = $("#cbxDescriptionName").val();

                        //if (cbxFileName != option || cbxAlterName != option || cbxDocumentUploadAt != option || cbxTags != option || cbxDescription != option) {
                        var lstFieldName = ["fileName", "alterName", "documentUploadAt", "tags", "description"];
                        //var lstExpresion = [$("#cbxFileName").prop("value"), $("#cbxAlterName").prop("value"), $("#cbxDateUploadFile").prop("value"), $("#cbxTags").prop("value"), $("#cbxDescriptionName").prop("value") ];
                        var lstExpresion = [$("#cbxFileName").val(), $("#cbxAlterName").val(), $("#cbxDateUploadFile").val(), $("#cbxTags").val(), $("#cbxDescriptionName").val()];
                        var lstFieldValue = [$("#txtFileName").val(), $("#txtAlterName").val(), $("#txtDateUploadFile").val(), $("#txtTags").val(), $("#txtDescription").val()];
                        var lstFieldType = ["string", "string", "datetime", "string", "string"];
                        for (var i = 0; i < lstFieldName.length; i++) {
                            if (lstExpresion[i] != "") {
                                if (lstExpresion[i] != expresionBetween) {
                                    var clsOperationFilterAzure = {
                                        "FieldName": lstFieldName[i],
                                        "ComparisonExpresion": lstExpresion[i],
                                        "FieldValue": lstFieldValue[i],
                                        "FieldType": lstFieldType[i]
                                    };
                                    lstFilterMetadata.push(clsOperationFilterAzure);
                                }
                                //TODO: AGREGAR LA EXPRESION BETWEEN
                            }
                        }
                        //}
                    }

                    $("#BuscarBlobs").click(function () {



                    });

</script>
}